<!-- Vehicle Detail Display Section -->
<% if (vehicleHTML) { %>
    <%- vehicleHTML %>

        <!-- Favorites Button (only shown if user is logged in) -->
        <% if (locals.accountData) { %>
            <div class="favorite-section">
                <button id="favorite-btn" class="favorite-btn <%= isFavorite ? 'is-favorite' : '' %>"
                    data-inv-id="<%= inv_id %>" onclick="toggleFavorite(<%= inv_id %>)">
                    <span class="heart-icon">
                        <%= isFavorite ? 'â¤ï¸' : 'ðŸ¤' %>
                    </span>
                    <span class="favorite-text">
                        <%= isFavorite ? 'Remove from Favorites' : 'Add to Favorites' %>
                    </span>
                </button>
            </div>
            <% } %>
                <% } else { %>
                    <% res.redirect('/') %>
                        <% } %>

                            <script>
                                // Client-side validation and favorite toggle
                                async function toggleFavorite(inv_id) {
                                    // Client-side validation
                                    if (!inv_id || inv_id <= 0) {
                                        alert('Invalid vehicle ID');
                                        return;
                                    }

                                    const btn = document.getElementById('favorite-btn');
                                    const originalHTML = btn.innerHTML;

                                    // Disable button during request
                                    btn.disabled = true;

                                    try {
                                        const response = await fetch('/favorites/toggle', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                            },
                                            body: JSON.stringify({ inv_id: inv_id })
                                        });

                                        const data = await response.json();

                                        if (data.success) {
                                            // Update button appearance
                                            const heartIcon = btn.querySelector('.heart-icon');
                                            const favoriteText = btn.querySelector('.favorite-text');

                                            if (data.action === 'added') {
                                                btn.classList.add('is-favorite');
                                                heartIcon.textContent = 'â¤ï¸';
                                                favoriteText.textContent = 'Remove from Favorites';
                                            } else {
                                                btn.classList.remove('is-favorite');
                                                heartIcon.textContent = 'ðŸ¤';
                                                favoriteText.textContent = 'Add to Favorites';
                                            }

                                            // Show success message
                                            showMessage(data.message, 'success');
                                        } else {
                                            alert(data.message || 'Failed to update favorite. Please try again.');
                                        }
                                    } catch (error) {
                                        console.error('Error:', error);
                                        alert('An error occurred. Please try again.');
                                    } finally {
                                        btn.disabled = false;
                                    }
                                }

                                function showMessage(message, type) {
                                    // Create a temporary message element
                                    const msgDiv = document.createElement('div');
                                    msgDiv.className = `flash-message ${type}`;
                                    msgDiv.textContent = message;
                                    document.querySelector('.favorite-section').prepend(msgDiv);

                                    // Remove after 3 seconds
                                    setTimeout(() => msgDiv.remove(), 3000);
                                }
                            </script>